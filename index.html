<script>
  // ==== LIFF初期化 ====
  document.addEventListener('DOMContentLoaded', function() {
    liff.init({ liffId: '2008265213-LlNnQxw2' })
      .then(() => console.log('LIFF init OK'))
      .catch(err => console.error('LIFF error', err));

    // ✅ 保存済みの名前を自動入力
    const savedName = localStorage.getItem('staffName');
    if (savedName) {
      document.getElementById('staffName').value = savedName;
    }

    generateShiftTable();
  });

  // ==== 祝日データ（省略）====

  function isHoliday(date) {
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const key = `${month}/${day}`;
    return holidayData[year] && holidayData[year].includes(key);
  }

  // ==== シフト表生成 ====
  function generateShiftTable() {
    const tbody = document.querySelector('#shiftTable tbody');
    tbody.innerHTML = '';
    const today = new Date();
    const monthOffset = parseInt(document.getElementById('monthSelect').value, 10);
    const targetDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
    const year = targetDate.getFullYear();
    const month = targetDate.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const weekdayNames = ['日','月','火','水','木','金','土'];

    for (let d = 1; d <= daysInMonth; d++) {
      const date = new Date(year, month, d);
      const day = date.getDay();
      const holiday = isHoliday(date);
      const isWeekend = (day === 0 || day === 6);
      const row = document.createElement('tr');
      if (holiday || isWeekend) row.classList.add('disabled-day');
      const disabledAttr = (holiday || isWeekend) ? 'disabled' : '';
      row.innerHTML = `
        <td>${month + 1}月${d}日</td>
        <td>${weekdayNames[day]}</td>
        <td><input type="time" class="shift-input start" ${disabledAttr}></td>
        <td><input type="time" class="shift-input end" ${disabledAttr}></td>
      `;
      tbody.appendChild(row);
    }
  }

  // ==== フルタイム自動入力 ====
  function fillFulltime() {
    const rows = document.querySelectorAll('#shiftTable tbody tr');
    rows.forEach(row => {
      if (row.classList.contains('disabled-day')) return;
      const weekday = row.cells[1].innerText;
      const startInput = row.querySelector('.start');
      const endInput = row.querySelector('.end');

      if (weekday === '月') {
        startInput.value = '10:00';
        endInput.value = '19:15';
      } else if (['火','水','木','金'].includes(weekday)) {
        startInput.value = '09:00';
        endInput.value = '18:15';
      }
    });
  }

  // ==== 送信 ====
  function submitShift() {
    const name = document.getElementById('staffName').value.trim();
    if (!name) { alert('お名前を入力してください'); return; }

    // ✅ 名前を保存（次回も自動入力）
    localStorage.setItem('staffName', name);

    const monthOffset = parseInt(document.getElementById('monthSelect').value, 10);
    const target = new Date();
    target.setMonth(target.getMonth() + monthOffset);
    const targetMonth = `${target.getFullYear()}年${target.getMonth() + 1}月`;

    const notes = document.getElementById('notes').value;
    const rows = document.querySelectorAll('#shiftTable tbody tr');
    let shifts = '';

    rows.forEach(row => {
      if (row.classList.contains('disabled-day')) return;
      const date = row.cells[0].innerText;
      const weekday = row.cells[1].innerText;
      const start = row.querySelector('.start').value;
      const end = row.querySelector('.end').value;
      if (start && end) {
        shifts += `・${date}（${weekday}） ${start}〜${end}\n`;
      }
    });

    if (!shifts) { alert('シフトを1件以上入力してください'); return; }

    const message =
      `≪シフト提出≫\n【お名前】${name}\n【対象月】${targetMonth}\n\n【シフト】\n${shifts}\n【備考】\n${notes || 'なし'}`;

    liff.sendMessages([{ type: 'text', text: message }])
      .then(() => {
        alert('送信が完了しました。ありがとうございます！');
        liff.closeWindow();
      })
      .catch(err => {
        console.error('送信エラー:', err);
        alert('送信に失敗しました。再度お試しください。');
      });
  }
</script>
